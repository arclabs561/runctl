name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Run unit tests
      run: cargo test --lib
    
    - name: Run integration tests
      run: cargo test --test integration_test
    
    - name: Check formatting
      run: cargo fmt -- --check
    
    - name: Check linting
      run: cargo clippy -- -D warnings
    
    # E2E tests require AWS credentials and are opt-in
    - name: Run E2E tests (if enabled)
      if: env.TRAINCTL_E2E == '1'
      env:
        TRAINCTL_E2E: ${{ secrets.TRAINCTL_E2E }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-east-1
      run: cargo test --test aws_resources_test --features e2e

