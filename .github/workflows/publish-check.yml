name: Publish Check

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  secret-scan-before-publish:
    name: Secret Scan (Pre-Publish)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run secret check script
        run: |
          chmod +x scripts/check-secrets.sh
          ./scripts/check-secrets.sh

      - name: Final secret scan before publish
        run: |
          # Critical: No secrets allowed before publishing
          if git grep -E "AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}" -- . :!scripts/check-secrets.sh :!docs/ :!.github/ :!tests/; then
            echo "::error::CRITICAL: Secrets found - cannot publish"
            exit 1
          fi
          echo "✓ No secrets found - safe to publish"

  check-publish-ready:
    name: Check Publish Readiness
    runs-on: ubuntu-latest
    needs: secret-scan-before-publish  # Must pass secret scan first
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Check Cargo.toml
        run: |
          # Check if package is configured for publishing
          if ! grep -q "repository" Cargo.toml; then
            echo "::error::Cargo.toml missing repository field (required for crates.io)"
            exit 1
          fi
          if ! grep -q "homepage" Cargo.toml; then
            echo "::warning::Cargo.toml missing homepage field"
          fi
          if ! grep -q "license" Cargo.toml; then
            echo "::error::Cargo.toml missing license field (required for crates.io)"
            exit 1
          fi
          if grep -q "publish = false" Cargo.toml; then
            echo "::error::Package is marked as not publishable - remove 'publish = false' to publish"
            exit 1
          fi
          echo "✓ Cargo.toml is properly configured"

      - name: Check authors
        run: |
          if grep -q "Your Name <you@example.com>" Cargo.toml; then
            echo "::error::Authors field still has placeholder - update before publishing"
            exit 1
          fi
          echo "✓ Authors field is configured"

      - name: Check version
        run: |
          VERSION=$(grep "^version" Cargo.toml | cut -d'"' -f2)
          echo "Current version: $VERSION"
          if [[ "$VERSION" == "0.0.0" ]]; then
            echo "::error::Version is still at 0.0.0 - update before publishing"
            exit 1
          fi
          echo "✓ Version is valid: $VERSION"

      - name: Check if already published
        run: |
          VERSION=$(grep "^version" Cargo.toml | cut -d'"' -f2)
          if cargo search runctl 2>/dev/null | grep -q "runctl = \"$VERSION\""; then
            echo "::error::Version $VERSION already published to crates.io"
            exit 1
          else
            echo "✓ Version $VERSION not yet published"
          fi

      - name: Verify package builds
        run: |
          cargo build --release
          echo "✓ Package builds successfully"

      - name: Run all tests
        run: |
          cargo test --lib
          cargo test --test integration_test || true
          echo "✓ All tests pass"

      # SECURITY: Only run publish checks on tags or manual dispatch from main branch
      # Never run on PRs from forks to prevent secret exposure
      - name: Dry-run publish
        if: |
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
        run: |
          cargo publish --dry-run --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish summary
        if: success()
        run: |
          VERSION=$(grep "^version" Cargo.toml | cut -d'"' -f2)
          echo "::notice::Package is ready to publish!"
          echo "Version: $VERSION"
          echo "To publish manually: cargo publish"

